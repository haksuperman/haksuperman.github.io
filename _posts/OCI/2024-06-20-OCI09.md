---
title: "[OCI] 통신을 위한 네트워크 설정 (with. 시큐리티 리스트, Bastion 세션, 서버 자체 방화벽)"       # 글 제목
date: 2024-06-20 14:35:00 +0900 # 작성 시간
categories: [CLOUD, OCI]        # [대분류, 소분류]
tags: [oci, cloud, oraclecloud, oracle cloud infrastructure, securitylist, bastion, os]     # 태그 (반드시 소문자로 시작 권장)
---
## 1\. 시큐리티 리스트 규칙 추가

현재 퍼블릭 서브넷에 배포한 애플리케이션 서버는 퍼블릭 IP 주소와 프라이빗 IP 주소를 모두 받았지만 데이터베이스 서버는 프라이빗 IP 주소만을 부여 받았다. 또한 화이트리스트 기반의 방화벽 관리가 동작돼서 기본적인 SSH 접속을 제외한 모든 프로토콜 접근이 차단되어 있다.

각 애플리케이션 서버와 데이터베이스 서버가 사용하는 포트번호인 5000번과 3306번 포트를 개방하는 시큐리티 리스트 규칙을 추가할 것이다.

> **화이트리스트 기반 관리**<br>
> 보통 모든 프로토콜을 차단하고 지정된 대상만을 허용 목록(화이트리스트)에 등록해서 해당 모록에 포함된 대상만을 접근이 가능하게 하는 접근 제어 방식이다.  
> 이를 통해 불필요한 트래픽 및 악성 공격을 차단하고 시스템 보안성을 향상시킬 수 있다.  
{: .prompt-info }

#### 1) 퍼블릭 서브넷의 5000번 포트 허용

1. \[Networking → Virtual cloud network\] 선택
![image](/assets/img/posts/OCI/OCI09_01.png)

2. OCI\_DEMO 선택
![image](/assets/img/posts/OCI/OCI09_02.png)

3. public subnet-OCI\_DEMO 선택
![image](/assets/img/posts/OCI/OCI09_03.png)

4. Default Security List for OCI\_DEMO 시큐리티 리스트가 적용되어 있다.
![image](/assets/img/posts/OCI/OCI09_04.png)

5. Default Security List for OCI\_DEMO 시큐리티 리스트는 모든 네트워크(0.0.0.0/0)에서의 SSH, ICMP와 VNC 네트워크 내(10.0.0.0/16)에서의 ICMP가 허용되어 있다.
![image](/assets/img/posts/OCI/OCI09_05.png)

6. Add Ingress Rules를 선택해 해당 시큐리티 리스트에 규칙을 추가할 수 있다.
![image](/assets/img/posts/OCI/OCI09_06.png)

7. 모든 네트워크 대역(0.0.0.0/0)에서의 5000번 포트로 향하는 패킷 허용
![image](/assets/img/posts/OCI/OCI09_07.png)

8. Add Ingress Rules를 선택해 해당 규칙 추가
![image](/assets/img/posts/OCI/OCI09_08.png)

#### 2) 프라이빗 서브넷의 3306 포트 허용

1. \[Networking → Virtual cloud network\] 선택
![image](/assets/img/posts/OCI/OCI09_09.png)

2. OCI\_DEMO 선택
![image](/assets/img/posts/OCI/OCI09_10.png)

3. private subnet-OCI\_DEMO 선택
![image](/assets/img/posts/OCI/OCI09_11.png)

4. security list for private subnet-OCI\_DEMO 시큐리티 리스트가 기본적으로 적용되어 있다.
![image](/assets/img/posts/OCI/OCI09_12.png)

5. VCN 내에서의 SSH, ICMP와 모든 네트워크에서의 ICMP가 허용되어 있다.
![image](/assets/img/posts/OCI/OCI09_13.png)

6. Add Ingress Rules를 선택해 이 시큐리티 리스트에 새로운 규칙 추가
![image](/assets/img/posts/OCI/OCI09_14.png)

7. VCN(10.0.0.0/16) 내에서 들어오는 3306번 포트 트래픽 허용
![image](/assets/img/posts/OCI/OCI09_15.png)

8. Add Ingress Rules 선택해 해당 규칙 추가
![image](/assets/img/posts/OCI/OCI09_16.png)

## 2\. Bastion 서비스 세션 추가

Bastion 서버를 생성하긴 했지만, Bastion 서비스를 통해 프라이빗 서브넷에 배포한 데이터베이스 서버에 접속하려면 세션을 생성해야 한다.

1. \[Identity & Security → Bastion\] 선택
![image](/assets/img/posts/OCI/OCI09_17.png)

2. 앞서 생성한 ocidemobastion 선택
![image](/assets/img/posts/OCI/OCI09_18.png)

3. Create session 선택
![image](/assets/img/posts/OCI/OCI09_19.png)

4. Session type : SSH port forwarding session
Session name : session-oci-demo-db
Connect to the target host by using : Instance name
Compute Instance : oci-demo-db(해당 인스턴스가 Running 상태여야 함)
Port : 22
Add SSH key : Choose SSH key file 선택 후 이전에 생성한 SSH 퍼블릭 키 업로드
![image](/assets/img/posts/OCI/OCI09_20.png)

5. 생성한 세션은 기본적으로 180분으로 설정된다.
![image](/assets/img/posts/OCI/OCI09_21.png)

6. 기본 값으로 180분을 변경하기 위해 세션 생성할 때 같이 변경해야 한다.
(생성된 세션 값의 TTL 값을 변경할 수 있으면 보안적으로 악용될 가능성이 있다)
![image](/assets/img/posts/OCI/OCI09_22.png)

> SSH 포트 포워딩  
> SSH 포트 포워딩 또는 SSH 터널링은 SSH 연결을 통해 암호화된 데이터를 전송하는 방법을 말한다. 이를 통해 로컬 포트와 원격 시스템 간에 보안 채널을 생성해 데이터를 안전하게 전달할 수 있다.  
> 이 기술은 인터넷 접근이 가능한 Bastion 호스트나 서비스를 통해 프라이빗 네트워크에 있는 자원에 접근할 때 사용되는 방법 중 하나이다.  
{: .prompt-info }

## 3\. 애플리케이션 및 데이터베이스 서버 접속

#### 1) 로컬 컴퓨터에서 애플리케이션 서버로 SSH 접속
1. 퍼블릭 IP 확인
![image](/assets/img/posts/OCI/OCI09_23.png)

2. ssh -i \<프라이빗 키 파일> opc@\<접속 대상 호스트> 로 접속<br>
(MobaXterm과 같은 프로그램을 통해 접속해도 된다)
![image](/assets/img/posts/OCI/OCI09_24.png)

> **OCI 패스워드 인증 방법**
> OCI 리눅스 인스턴스는 기본적으로 SSH 키 페어 인증 방식을 사용한다. 특정 상황에 패스워드 인증 방식을 사용할 수 있는데, 먼저 프라이빗 키로 로그인 한 후에 패스워드 인증 방식으로 변경해야 한다.  
> (OCI 리눅스 인스턴스의 기본 사용자 opc 외에 별도 사용자를 생성해 진행해도 된다)  
>   
> 하지만 패스워드 인증 방식은 보안 상 취약하기 때문에 가능하면 SSH 키 페어 인증 방식을 권장하며, 필요한 경우에만 사용해야 한다.  
>   
> 1) opc 유저 패스워드 설정  
> ```shell
> sudo passwd opc
> ```
>
> 2) 패스워드 인증 방식의 원격 접속 허용  
> ```shell
> # PasswordAuthentication 값 Yes로 변경
> vi /etc/ssh/sshd_config
> ```
> 
> 3) sshd 설정 파일 에러 체크 및 데몬 재실행  
> ```shell
> sudo /sbin/sshd -t
> sudo systemctl restart sshd
> sudo systemctl status sshd
> ```
{: .prompt-info }

#### 2) Bastion 서비스를 활용해 프라이빗 서브넷의 데이터베이스 서버 접속

이전에 생성한 Session을 통해 접속할 수 있다. 접속하는 방법은 Session 섹션에서 확인 가능하다.


1. \[Identity & Security → Bastion\] 선택
![image](/assets/img/posts/OCI/OCI09_25.png)

2. 생성한 Bastion 선택
![image](/assets/img/posts/OCI/OCI09_26.png)

3. 위에서 생성한 세션 햄버거 메뉴 선택
![image](/assets/img/posts/OCI/OCI09_27.png)

4. Copy SSH command 선택
![image](/assets/img/posts/OCI/OCI09_28.png)

5. 메모장에서 형태 확인<br>
\<privateKey> 부분을 로컬 컴퓨터에 저장된 프라이빗 키의 경로와 파일명으로 변경<br>
\<localPort> 부분을 Bastion에 연결하려는 로컬 포트로 변경
![image](/assets/img/posts/OCI/OCI09_29.png)

6. 개인키 경로 입력 및 로컬 포트로 22222번 사용
![image](/assets/img/posts/OCI/OCI09_30.png)

    > **SSH config**  
    > 로컬 컴퓨터가 OpenSSH 9 버전 이상을 사용하면 Bastion 서비스를 통해 프라이빗 서브넷의 호스트에 접근 시 "no matching host key type found"와 같은 RSA 키 인증 오류가 발생할 수 있다.  
    > 이 경우 인증 알고리즘을 지정하는 내용의 config 파일을 로컬 컴퓨터의 .ssh 디렉터리에 생성해서 해결할 수 있다.  
    >   
    > % ssh -V  
    > OpenSSH\_9.0p1, LibreSSL 3.3.6  
    >   
    > % sudo vi ./.ssh/config  
    > Host \*  
    > HostkeyAlgorithms +ssh-rsa  
    > PubkeyAcceptedAlgorithms +ssh-rsa
    {: .prompt-info }

7. 먼저 Bastion 서비스로 연결되고, RSA key fingerprint가 내부 Bastion 호스트에 등록되는 과정을 거친다.
![image](/assets/img/posts/OCI/OCI09_31.png)

8. Bastion을 통해 포트포워딩 시키는 명령을 입력해놓은 터미널을 켜두고, 별도 터미널 창에서 ssh 접속<br>
(로컬 포트로 지정한 포트로 접속해야 정상적인 포트 포워딩이 이루어짐)
![image](/assets/img/posts/OCI/OCI09_32.png)

9. hostname 명령으로 oci-demo-db 가상 머신 인스턴스에 접속한 것 확인
![image](/assets/img/posts/OCI/OCI09_33.png)


> 이전에 ssh 명령으로 접속한 적이 있다면 "Someone cloud be eavesdropping on you right now (man-in-the-middle attack)!"과 같은 메시지와 함께 접속에 실패할 수 있다.  
> 이 경우 로컬 컴퓨터 .ssh 디렉터리 아래에 "known\_hosts" 파일을 삭제하고 다시 수행하면 된다.
{: .prompt-info }

## 4\. 애플리케이션, 데이터베이스 통신 포트 개방 설정

애플리케이션과 데이터베이스 서버 간의 포트 통신을 설정해야 한다.

SSH 22번 포트를 제외하고는 가상 머신 호스트 레벨에서 모든 통신이 차단되어 있기 때문에 5000번 포트와 3306번 포트에 대한 호스트 레벨의 방화벽 개방 작업도 필요하다.

#### 1) 애플리케이션 서버 가상 머신 자체의 방화벽 설정
1. 애플리케이션 서버 가상 머신 SSH 접속
![image](/assets/img/posts/OCI/OCI09_34.png)

2. firewall-cmd 명령으로 5000번 포트 개방
```shell
sudo firewall-cmd --permanent --zone=public --add-port=5000/tcp
sudo firewall-cmd --reload
sudo firewall-cmd --list-all
```
![image](/assets/img/posts/OCI/OCI09_35.png)


#### 2) 데이터베이스 서버 가상 머신 자체의 방화벽 설정

1. 데이터베이스 서버 가상 머신 SSH 접속
![image](/assets/img/posts/OCI/OCI09_36.png)

2. firewall-cmd 명령으로 3306번 포트 개방
```bash
sudo firewall-cmd --permanent --zone=public --add-port=3306/tcp
sudo firewall-cmd --reload
sudo firewall-cmd --list-all
```
![image](/assets/img/posts/OCI/OCI09_37.png)