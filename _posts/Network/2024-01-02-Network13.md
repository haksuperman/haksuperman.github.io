---
title: L3 Switching, VLAN      # 글 제목
date: 2024-01-02 01:06:00 +0900 # 작성 시간
categories: [ON-PREMISE, NETWORK]        # [대분류, 소분류]
tags: [network, l3switching, vlan]     # 태그 (반드시 소문자로 시작 권장)
---
![image](/assets/img/posts/Network/Network13_01.png)

1\. 유니캐스트(Unicast)

\- 1:1(S:D) 통신

\- 카톡의 갠톡 개념

2\. 멀티캐스트(Multicast)

\- 1:Group(S:D) 통신

\- 카톡의 단톡 개념

3\. 브로드캐스트(Broadcast), 제한된 브로드캐스트(Limited Broadcast)

\- 1:ALL(S:D) 통신

\- 동일 네트워크 내에서만 ALL

\- '제한되었다'의 의미

\-- 송신자가 소속된 Network 내의 모든 Hosts

\-- 라우터가 브로드캐스트 도메인을 나누는 역할을 하는 것

\-> 이렇게 제한된 영역을 브로드캐스트 도메인(Broadcast Domain)이라고 부름

\- 1:1로 통신을 하고 싶어도 브로드캐스트 통신은 원하지 않는 호스트들에도 전달됨

\-- 브로드캐스트 도메인을 분할하면 브로드캐스트 통신의 대상이 적어짐(=물리 네트워크를 분할, 라우터가 필요)

\-- 원래 이더넷(LAN) 구간에서 브로드캐스트 도메인을 분할하려고 라우터를 쓰게 되면(많은 포트, 큰 대역폭이 필요) 무리데쓰요..

\-> L3 스위치가 해결책으로 제시됨

\- L3 스위치

\-- 라우터가 물리적인 네트워크를 분할한다면, L3 스위치는 논리적으로 분할해 줌

\-- 이때, VLAN(Virtual LAN)의 기술이 들어감

\-- 라우팅 기능이 있는 L3 스위치를 통해 라우팅의 효과를 냄

\-> L3 스위치의 VLAN 기술을 이용해 논리적으로 네트워크를 분할함, 논리적으로 브로드캐스트 도메인을 분할함

![image](/assets/img/posts/Network/Network13_02.png)

\- 네트워크가 분할되면 그에 맞는 ip 구성도 달라져야 함(서브넷팅을 통해 분할하는 것)

\-- VLAN 별로 네트워크 대역도 달라야 한다는 뜻

\-- 이때, 네트워크 개수 기준 or 호스트 기준의 서브넷팅이 필요함

\-- ex. VLAN을 4개 만들었으면 원래의 네트워크 대역에서 네트워크 4개 기준으로 서브넷팅

\-- 원래의 DSW(분배 스위치)가 각 VLAN의 게이트웨이 역할을 하게 됨

\- 각 VLAN 별로 ip를 자동으로 배포할 수 있도록 DSW에 DHCP 서버를 둠

\-- 각 VLAN 별에 딸린 host에 ip를 직접 하나하나 수동으로 입력하지 않아도 됨

\-- 꼭 VLAN이 아닌 일반적인 하나의 네트워크에서도 DHCP 사용 가능

\-- DHCP는 L7에서 동작하는데, ip를 배포해주는 서비스기 때문에 최소 L3는 만족을 해줘야 함

#### VLAN(Virtual LAN)

\= A Broadcast Domain(하나의 브로드캐스트 도메인)

\= A IP Subnet(하나의 아이피 서브넷)

\= A network(하나의 네트워크)

![image](/assets/img/posts/Network/Network13_03.png)

![image](/assets/img/posts/Network/Network13_04.png)

![image](/assets/img/posts/Network/Network13_05.png)

위 스위치 구성에서 ping 10.0.0.6/24로 보냈을 때

​

L3에서 도착지의 ip인 10.0.0.6/24의 MAC주소를 알아와서 해당 정보를 같이 L2로 보내줌, 그래야 L2 내려가서 패킷을 뜯어볼 때 도착지 MAC을 알 수 있음

\* ARP 과정

1) 출발지인 10.0.0.1 - A1에서 동일 네트워크까지 브로드캐스트 통신으로 ARP 패킷을 보냄

2) 동일 네트워크 내의 모든 호스트들이 ARP 패킷을 수신하게 됨

3-1) 도착지의 ip 정보를 보고 '어 나다!' 하면 '내 MAC주소는 A6야'하고 출발지에 ARP 응답 패킷을 보냄

3-2) 도착지의 ip 정보를 보고 '나 아닌디….;;' 하면 해당 ARP 패킷을 DROP시켜서 내다 버림

\=> L3 계층에서 DST의 MAC주소를 알아와서 출발지인 자신의 ip와 mac 주소, 도착지의 ip와 알아온 mac을 담아 L2 계층으로 보냄, L2 계층에서 내려 받은 패킷의 헤더 정보를 뜯어 보고 출발지와 도착지의 MAC 주소를 보고 옳다구나 하고 대상 호스트에 MAC 통신으로 전송해 줌(L1의 물리적 연결을 통해)

---

![image](/assets/img/posts/Network/Network13_06.png)

한 네트워크 안에 여러 대의 SW가 연결된 경우

(애초에 물리적으로 다른 SW 안에 번호만 같은 VLAN들이 있을 수 있음)

​

SW1의 VLAN 10의 정보를 SW2의 VLAN 10에 전송하게 되면 전류가 흐르는 물리적인 연결에서는 VLAN 정보가 없음, 그래서 꼬리표(tag)를 붙여서 전송해줘야 함

\* L2 계층에서는 전송되는 헤더 정보(Data Unit)를 Frame이라고 부름(L3는 Packet, L4는 Segment)

![image](/assets/img/posts/Network/Network13_07.png)

VLAN 정보(tag)를 담기 위해 4byte의 공간을 추가해서 다시 생성함

이러한 과정을 최소화 해야 과부하를 막을 수 있음

![image](/assets/img/posts/Network/Network13_08.png)

\- 스위치의 CPU는 VLAN 정보가 없는 Frame만을 인식(스위치 CPU가 처리하는 Frame에는 VLAN 정보가 담긴 Frame은 에러로 처리함)하기 때문에 인터페이스에서 VLAN 정보가 담긴 꼬리표(tag)를 붙였다가 수신지 인터페이스에서 떼고 스위치의 CPU로 전달함

\- 이 인터페이스는 어느 vlan의 정보인지 구분을 하지 못하기 때문에 어느 VLAN의 정보가 담긴 꼬리표(tag)를 붙여야 하는지 모르고, 그리고 수신지에서도 스위치의 어느 VLAN에게 전달해야 하는지 모름(어느 vlan에도 속하지 않음)

\-> 이 인터페이스에 특별한 기능인 어느 vlan에도 속하지 않는다는 의미로 trunk port 설정을 해줘야 함

(하나의 vlan만 전송한다면 굳이 안하고 access port로 설정해도 됨)

\* 하나의 vlan만이 소속된 port를 access port / 그 어느 vlan에도 속하지 않는 포트를 trunk port

---

GNS3에서는 라우터를 스위치로 변경해서 사용했기 때문에 show vlan-switch (brief)로 쳐야 함

(실제 라우터에서는 show vlan만 하면 됨)

![image](/assets/img/posts/Network/Network13_09.png)

위 토폴로지로 구성(아직 vlan 설정은 안함)

![image](/assets/img/posts/Network/Network13_10.png)

모든 포트가 기본 값으로 vlan 1에 소속되어 있음

\-> 같은 vlan 1에 소속되어 있어 모든 포트가 통신이 가능

(=같은 스위치에 물려있어서 호스트들이 통신이 되는 것이 아니라, 하나의 같은 vlan 안에 속해 있어서 통신이 되는 것으로 생각해야 함)

![image](/assets/img/posts/Network/Network13_11.png)

vlan을 생성

![image](/assets/img/posts/Network/Network13_12.png)

vlan의 이름을 변경함

![image](/assets/img/posts/Network/Network13_13.png)

인터페이스를 범위로 한번에 지정하고, access port 모드로 설정 후 해당 인터페이스(access port)를 vlan 10으로 할당

![image](/assets/img/posts/Network/Network13_14.png)

인터페이스를 범위로 한번에 지정하고, access 모드로 설정 후 해당 인터페이스(access port)를 vlan을 할당함

![image](/assets/img/posts/Network/Network13_15.png)

vlan끼리는 통신 가능, vlan으로 분리된 네트워크에는 통신이 x

\-> 애초에 '게이트웨이를 못 찾는다'는 문구 자체가 다른 네트워크(다른 VLAN)로 인식된 것

---

![image](/assets/img/posts/Network/Network13_16.png)

같은 vlan이더라도 물리적으로 스위치가 달라서 통신이 안됨(vlan 10: 빨간라인, vlan 20: 파란라인)

![image](/assets/img/posts/Network/Network13_17.png)

ESW1과 ESW2의 trunk port 라인이 vlan 10으로 access port 되어 있어서 vlan 10과 vlan 20의 통신이 안됨(vlan 10 길로 설정하면, vlan 20번은 못감)

\-> ESW1의 fa1/15와 ESW2의 fa1/15 라인을 trunk port로 설정해야 함(trunk port는 그 어떤 vlan에도 속하지 않으니 다양한 vlan이 지나다닐 수 있음)

​

trunk port 설정하기

![image](/assets/img/posts/Network/Network13_18.png)

해당 인터페이스에 들어가서,

ESW1의 fa 1/15를 encapsulation(캡슐화) 방식을 dot1q로 trunk port 설정

![image](/assets/img/posts/Network/Network13_19.png)
![image](/assets/img/posts/Network/Network13_20.png)

라인의 반대편 장비도 똑같이 맞춰줘야 함

![image](/assets/img/posts/Network/Network13_21.png)

access port(하나의 포트에 하나의 vlan만 할당된) 목록(#show vlan-sw)에 아예 사라짐

![image](/assets/img/posts/Network/Network13_22.png)

해당 명령으로 trunk port 설정한 것 확인 가능

​

\* 802.1q : 가상 랜에 대한 IEEE 802.1

![image](/assets/img/posts/Network/Network13_23.png)

해당 라인을 trunk port로 만들어줬기 때문에 통신 가능

---

![image](/assets/img/posts/Network/Network13_24.png)

ESW1은 두 VLAN을 분리하는 역할만 함, 다른 네트워크끼리 통신이 되도록 하려면 vlan을 나눠준 스위치 위에 L3 기능이 있는 장비를 두고 연결시켜줘야 함(IVR 장비, Inter VLAN Router)

![image](/assets/img/posts/Network/Network13_25.png)

서로 다른 VLAN(네트워크)을 연결해주는 라우팅 기능이 있는 L3 계층의 Inter VLAN Router(IVR)가 필요함

(이때 사용하는 Routing Protocol은 static, dynamic 상관 없음)

​

L3 스위치를 L3 기능을 하도록 설정하는 방법

1) SVI

2) Routed Interface

\=> SVI, Routed Interface의 방법으로 L3 스위치에서 L3 기능을 사용할 수 있음

\* L3 스위치를 L3 기능을 하도록 하려면 물리 interface와 논리 interface의 구분이 필요함

![image](/assets/img/posts/Network/Network13_26.png)

\- int fa 0/0

\- int se 0/0

\=> 물리 인터페이스

\- int loopback 0

\- int vlan 10 -> SVI에 사용

\- int turnel 10 -> VPN에 사용

\- int fa 0/0.12

\=> 가상 인터페이스

​

#### SVI(Switched Virtual Interface)

\- 생성한 가상 인터페이스인 SVI가 살아있으려면 조건이 충족되어야 함(무던하지 못한 자식)

​

1) 해당 VLAN이 존재 & Alive

int vlan \[number\]

\-> vlan 10, 20과는 별개(vlan 자체를 10, 20 두개 만든 것), int vlan 10은 vlan 인터페이스 자체를 의미

2) 해당 VLAN의 member가 존재 & Alive

int fa 1/0

switchport mode access

switchport access vlan 10

\=> 해당 vlan에 member로 속해 있어야 함

( access port : 하나의 포트에 하나의 vlan만 할당 / trunk port : 하나의 포트에 하나 이상의 vlan 할당 )

3) 목적 : 각 VLAN의 Gateway로 사용하기 위해서 사용

![image](/assets/img/posts/Network/Network13_27.png)

\* vlan도 shutdown, no shut 가능

​

Routed Interface

![image](/assets/img/posts/Network/Network13_28.png)

\-> 실제 물리적인 포트 스위치 포트를 (config)#no switchport 명령어로 스위치 기능을 끄고 라우팅 기능만 살아 있도록 하는 것

---

\* 기존의 토폴로지에 새로운 구성을 추가하면 protocol 상 다운되는 경우가 많음(GNS3 오류)

\-> shut 했다가 no shut으로 해결 가능

---

![image](/assets/img/posts/Network/Network13_29.png)
![image](/assets/img/posts/Network/Network13_30.png)

기존에 연결했던 ESW1과 ESW2의 fa1/15의 trunk port 라인이 없어도 ESW3를 통해 통신 가능하도록 설정할 수 있음

\-> 퉤 버려 그냥

![image](/assets/img/posts/Network/Network13_31.png)

ESW1

conf t

int fa 1/15

no switchport trunk encapsulation dot1q

no switchport mode trunk

​

![image](/assets/img/posts/Network/Network13_32.png)

ESW2

conf t

int fa 1/15

no switchport trunk encapsulation dot1q

no switchport mode trunk

![image](/assets/img/posts/Network/Network13_33.png)

ESW3(IVR)에 SVI(int vlan 10, 20)를 만들려면 두가지 조건이 충족되어야 하는데

\- VLAN 10, 20이 존재해야 하고

\- f1/10과 f1/11이 각 vlan에 멤버가 되어야 한다

\-> 하나의 인터페이스(f 1/10)에 두 개의 vlan을 소속 시킬 수 없음

\-> 어차피 ESW1과 ESW3의 fa1/10 연결 라인을 trunk 설정해야 vlan 10, 20이 지나가야 함

\=> 이렇게 되면 멤버가 되어야 하는 두번째 충족 조건은 trunk로 해결이 되는 건가?

\=> **access port가 하나의 포트에 하나의 vlan만 할당되니까 반대로 하나의 포트에 여러 개의 vlan을 할당하려면 trunk port로 설정하는 것이 맞는듯**

ESW1과 ESW3의 f1/10 포트의 trunk 설정을 해주자

ESW1

conf t

int fa 1/10

switchport trunk encapsulation dot1q

switchport mode trunk

ESW3

conf t

int fa 1/10

switchport trunk encapsulation dot1q

switchport mode trunk

![image](/assets/img/posts/Network/Network13_34.png)
![image](/assets/img/posts/Network/Network13_35.png)

ESW2와 ESW3의 f1/11 포트의 trunk 설정을 해주자

ESW2

conf t

int fa 1/11

switchport trunk encapsulation dot1q

switchport mode trunk

ESW3

conf t

int fa 1/11

switchport trunk encapsulation dot1q

switchport mode trunk

![image](/assets/img/posts/Network/Network13_36.png)
![image](/assets/img/posts/Network/Network13_37.png)

ESW3에서 SVI 설정하기

![image](/assets/img/posts/Network/Network13_38.png)

먼저 SVI 생성을 위해 해당 vlan을 만듦

( (config)# vlan 10,20 )

![image](/assets/img/posts/Network/Network13_39.png)

SVI 생성하고 ip 부여(각 vlan 별로 게이트웨이 역할을 SVI가 하게 됨)

( (config-if)#ip add 10.0.10.254 255.255.255.0 )

( (config-if)#ip add 10.0.20.254 255.255.255.0 )

![image](/assets/img/posts/Network/Network13_40.png)

다른 VLAN을 찾아갈 수 있도록 라우팅 기능을 켬

( (config)#ip routing )

![image](/assets/img/posts/Network/Network13_41.png)

![image](/assets/img/posts/Network/Network13_42.png)

![image](/assets/img/posts/Network/Network13_43.png)

![image](/assets/img/posts/Network/Network13_44.png)

![image](/assets/img/posts/Network/Network13_45.png)

![image](/assets/img/posts/Network/Network13_46.png)

![image](/assets/img/posts/Network/Network13_47.png)

![image](/assets/img/posts/Network/Network13_48.png)

![image](/assets/img/posts/Network/Network13_49.png)

본인 대역(vlan 10)의 게이트웨이, 다른 대역(vlan 20)으로 핑 안됨

\-> GNS3 문제다

​

![image](/assets/img/posts/Network/Network13_50.png)

애초에 같은 vlan으로는 SVI 만든 게이트웨이를 찾아갈 필요가 없음

(trunk 설정은 잘 들어갔으니 같은 vlan으로 통해 잘 감)

![image](/assets/img/posts/Network/Network13_51.png)

다른 VLAN을 찾아가야하는 VLAN 20으로는 게이트웨이를 찾아서 나가야하는데, 게이트웨이를 찾으러가는 패킷이 캡처되지 않음

\-> 이미지를 EtherSwitch 3745로 등록했었는데, EtherSwitch 3725로 다시 등록해서 해보자(강사님은 성공함….)

---

![image](/assets/img/posts/Network/Network13_52.png)

새로 받은 이미지 파일 3725를 등록해서 다시 진행…..

![image](/assets/img/posts/Network/Network13_53.png)
![image](/assets/img/posts/Network/Network13_54.png)

각 스위치에 vlan 생성

ESW2

conf t

vlan 10,20

do show vlan-sw

ESW3

conf t

vlan 10,20

do show vlan-sw

​

![image](/assets/img/posts/Network/Network13_55.png)

스위치 별 vlan 할당

ESW2

conf t

int range fa 1/0 - 1

switchport mode access

switchport access vlan 10

exit

int range fa 1/2 - 3

switchport mode access

switchport access vlan 20

do show vlan-sw

ESW2와 IVR의 fa 1/10 trunk port 설정

![image](/assets/img/posts/Network/Network13_56.png)

ESW2

conf t

int fa 1/10

switchport trunk encapsulation dot1q

switchport mode trunk

do show interface trunk

IVR

conf t

int fa 1/10

switchport trunk encapsulation dot1q

switchport mode trunk

do show interface trunk

​

​

ESW3와 IVR의 fa 1/11 trunk port 설정

![image](/assets/img/posts/Network/Network13_57.png)

ESW3

conf t

int fa 1/11

switchport trunk encapsulation dot1q

switchport mode trunk

do show interface trunk

IVR

conf t

int fa 1/11

switchport trunk encapsulation dot1q

switchport mode trunk

do show interface trunk

​

IVR에서 SVI 생성을 위한 vlan 10,20 생성

![image](/assets/img/posts/Network/Network13_58.png)

IVR

conf t

vlan 10,20

do show vlan-sw

​

​

각 vlan의 게이트웨이로 사용할 SVI 생성 후 ip 부여

![image](/assets/img/posts/Network/Network13_59.png)

IVR

conf t

int vlan 10

ip add 10.0.10.254 255.255.255.0

exit

int vla 20

ip add 10.0.20.254 255.255.255.0

do show ip int vlan 10

do show ip int vlan 20

IVR의 생성한 SVI(게이트웨이)까지는 핑 가능

![image](/assets/img/posts/Network/Network13_60.png)

​

​

​

다른 VLAN을 넘어서는 불가능(vlan으로 나눠서 다른 네트워크가 됐기 때문에 라우팅이 필요함)

![image](/assets/img/posts/Network/Network13_61.png)

​

​

​

IVR에서 라우팅 기능을 활성화

![image](/assets/img/posts/Network/Network13_62.png)

connected 라인으로 vlan10과 vlan20은 통신 가능

![image](/assets/img/posts/Network/Network13_63.png)

휴....

아까 안된 장비 이미지 누가 만든거야;;